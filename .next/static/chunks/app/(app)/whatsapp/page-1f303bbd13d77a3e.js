(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[438],{6903:function(e,t,s){Promise.resolve().then(s.bind(s,3543))},3543:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return m}});var a=s(7437),r=s(2265),n=s(6463),i=s(6474),l=s(7776),c=s(6706),d=s(4817),o=s(7583);/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let x=(0,s(8030).Z)("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);var u=s(994);let h={Nou:"#94a3b8",Contactat:"#3a7bd5","\xcent\xe2lnire programată":"#c9a84c","Ofertă trimisă":"#8b5cf6","Client activ":"#00c48c",Pierdut:"#e05050"};function m(){let[e,t]=(0,r.useState)([]),[s,m]=(0,r.useState)([]),[f,p]=(0,r.useState)(null),[g,v]=(0,r.useState)([]),[b,j]=(0,r.useState)(""),[y,w]=(0,r.useState)(""),[N,_]=(0,r.useState)(!1),[S,k]=(0,r.useState)(!0),[C,E]=(0,r.useState)(!1),Z=(0,r.useRef)(null),L=(0,n.useSearchParams)(),P=(0,i.e)();async function M(){let{data:e}=await P.from("whatsapp_conversations").select("*, lead:lead_id(name, status)").order("last_message_at",{ascending:!1});t(e||[]),m(e||[]),k(!1)}async function z(e){E(!0);let{data:s}=await P.from("whatsapp_messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});v(s||[]),E(!1),await P.from("whatsapp_conversations").update({unread_count:0}).eq("id",e),t(t=>t.map(t=>t.id===e?{...t,unread_count:0}:t))}async function A(e){p(e),v([]),w(""),await z(e.id)}async function R(){if(y.trim()&&f&&!N){_(!0);try{let e=await fetch("/api/whatsapp/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({conversationId:f.id,message:y.trim()})}),t=await e.json();if(!e.ok)throw Error(t.error);w("")}catch(e){l.A.error(e.message)}finally{_(!1)}}}(0,r.useEffect)(()=>{M().then(()=>{L.get("conv")})},[]),(0,r.useEffect)(()=>{let t=L.get("conv");if(t&&e.length>0){let s=e.find(e=>e.id===t);s&&(!f||f.id!==t)&&A(s)}},[e,L]),(0,r.useEffect)(()=>{let e=P.channel("whatsapp_realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"whatsapp_messages"},e=>{let t=e.new;f&&t.conversation_id===f.id&&v(e=>[...e,t]),M()}).on("postgres_changes",{event:"INSERT",schema:"public",table:"whatsapp_conversations"},()=>{M()}).subscribe();return()=>{P.removeChannel(e)}},[f]),(0,r.useEffect)(()=>{var e;null===(e=Z.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[g]),(0,r.useEffect)(()=>{if(!b){m(e);return}m(e.filter(e=>{var t,s,a,r;return(null===(t=e.wa_name)||void 0===t?void 0:t.toLowerCase().includes(b.toLowerCase()))||(null===(s=e.wa_phone)||void 0===s?void 0:s.includes(b))||(null===(r=e.lead)||void 0===r?void 0:null===(a=r.name)||void 0===a?void 0:a.toLowerCase().includes(b.toLowerCase()))}))},[b,e]);let T=e.reduce((e,t)=>e+(t.unread_count||0),0);return(0,a.jsxs)("div",{className:"flex-1 flex overflow-hidden",children:[(0,a.jsxs)("div",{className:"w-80 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col",children:[(0,a.jsxs)("div",{className:"px-4 py-3 border-b border-gray-200",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("h1",{className:"text-sm font-semibold",children:"WhatsApp"}),T>0&&(0,a.jsx)("span",{className:"bg-[#00c48c] text-white text-[10px] font-bold px-2 py-0.5 rounded-full",children:T})]}),(0,a.jsx)("button",{onClick:M,className:"text-gray-400 hover:text-[#004437] transition-colors",children:(0,a.jsx)(c.Z,{size:14})})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5",children:[(0,a.jsx)(d.Z,{size:13,className:"text-gray-400"}),(0,a.jsx)("input",{className:"bg-transparent text-sm outline-none flex-1 placeholder:text-gray-400",placeholder:"Caută conversație...",value:b,onChange:e=>j(e.target.value)})]})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto",children:S?(0,a.jsx)("div",{className:"flex items-center justify-center h-32 text-gray-400 text-sm",children:"Se \xeencarcă..."}):0===s.length?(0,a.jsxs)("div",{className:"text-center py-16 px-4",children:[(0,a.jsx)(o.Z,{size:32,className:"mx-auto text-gray-300 mb-3"}),(0,a.jsx)("p",{className:"text-sm text-gray-400 font-medium",children:"Nicio conversație"}),(0,a.jsx)("p",{className:"text-xs text-gray-400 mt-1",children:"Mesajele de pe WhatsApp Business vor apărea automat aici"})]}):s.map(e=>{var t;let s=(e.wa_name||e.wa_phone).substring(0,2).toUpperCase(),r=(null==f?void 0:f.id)===e.id,n=(null===(t=e.lead)||void 0===t?void 0:t.status)?h[e.lead.status]:"#94a3b8";return(0,a.jsx)("div",{onClick:()=>A(e),className:"px-4 py-3 cursor-pointer border-b border-gray-100 transition-colors ".concat(r?"bg-[#e8f0ee]":"hover:bg-gray-50"),children:(0,a.jsxs)("div",{className:"flex items-start gap-3",children:[(0,a.jsxs)("div",{className:"relative flex-shrink-0",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full bg-[#25d366] flex items-center justify-center text-white text-xs font-bold",children:s}),e.unread_count>0&&(0,a.jsx)("span",{className:"absolute -top-1 -right-1 w-4 h-4 bg-[#00c48c] rounded-full flex items-center justify-center text-[9px] font-bold text-white",children:e.unread_count>9?"9+":e.unread_count})]}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between gap-1",children:[(0,a.jsx)("span",{className:"text-sm font-semibold text-gray-900 truncate",children:e.wa_name||e.wa_phone}),(0,a.jsx)("span",{className:"text-[10px] text-gray-400 flex-shrink-0",children:e.last_message_at?function(e){let t=new Date(e),s=new Date,a=s.getTime()-t.getTime();return a<6e4?"acum":a<36e5?Math.floor(a/6e4)+"m":t.toDateString()===s.toDateString()?t.toLocaleTimeString("ro-RO",{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString("ro-RO",{day:"2-digit",month:"short"})}(e.last_message_at):""})]}),e.lead&&(0,a.jsxs)("div",{className:"flex items-center gap-1 mb-0.5",children:[(0,a.jsx)("span",{className:"w-1.5 h-1.5 rounded-full flex-shrink-0",style:{background:n}}),(0,a.jsx)("span",{className:"text-[10px] text-gray-500 truncate",children:e.lead.name})]}),(0,a.jsx)("p",{className:"text-xs text-gray-400 truncate",children:e.last_message||"—"})]})]})},e.id)})})]}),f?(0,a.jsxs)("div",{className:"flex-1 flex flex-col overflow-hidden",children:[(0,a.jsxs)("div",{className:"bg-white border-b border-gray-200 px-6 h-14 flex items-center justify-between flex-shrink-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-8 h-8 rounded-full bg-[#25d366] flex items-center justify-center text-white text-xs font-bold",children:(f.wa_name||f.wa_phone).substring(0,2).toUpperCase()}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm font-semibold text-gray-900",children:f.wa_name||f.wa_phone}),(0,a.jsxs)("div",{className:"text-xs text-gray-400",children:["+",f.wa_phone]})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[f.lead_id&&(0,a.jsxs)("a",{href:"/contacts",className:"flex items-center gap-1.5 text-xs text-[#004437] border border-[#c2d9d3] px-3 py-1.5 rounded-lg hover:bg-[#e8f0ee] transition-colors",children:[(0,a.jsx)(x,{size:12}),"Vezi fișa contact"]}),(0,a.jsxs)("a",{href:"https://wa.me/".concat(f.wa_phone),target:"_blank",className:"flex items-center gap-1.5 text-xs text-green-700 border border-green-200 px-3 py-1.5 rounded-lg hover:bg-green-50 transition-colors",children:[(0,a.jsx)(o.Z,{size:12}),"Deschide WA"]})]})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-2 bg-[#f0f2f5]",children:[C?(0,a.jsx)("div",{className:"flex items-center justify-center h-32 text-gray-400 text-sm",children:"Se \xeencarcă mesajele..."}):0===g.length?(0,a.jsx)("div",{className:"flex items-center justify-center h-32 text-gray-400 text-sm",children:"Niciun mesaj \xeencă"}):g.map(e=>{let t="outbound"===e.direction;return(0,a.jsx)("div",{className:"flex ".concat(t?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"max-w-xs lg:max-w-md xl:max-w-lg rounded-2xl px-4 py-2.5 shadow-sm ".concat(t?"bg-[#004437] text-white rounded-br-sm":"bg-white text-gray-900 rounded-bl-sm"),children:[(0,a.jsx)("p",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:e.body}),(0,a.jsxs)("div",{className:"flex items-center gap-1 mt-1 ".concat(t?"justify-end":"justify-start"),children:[(0,a.jsx)("span",{className:"text-[10px] ".concat(t?"text-white/60":"text-gray-400"),children:new Date(e.created_at).toLocaleTimeString("ro-RO",{hour:"2-digit",minute:"2-digit"})}),t&&(0,a.jsx)("span",{className:"text-[10px] text-white/60",children:"read"===e.status?"✓✓":"delivered"===e.status?"✓✓":"✓"})]})]})},e.id)}),(0,a.jsx)("div",{ref:Z})]}),(0,a.jsxs)("div",{className:"bg-white border-t border-gray-200 px-4 py-3 flex items-end gap-3",children:[(0,a.jsx)("textarea",{className:"flex-1 resize-none border border-gray-200 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-[#004437] transition-colors max-h-32 min-h-[44px]",placeholder:"Scrie un mesaj...",value:y,onChange:e=>w(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),R())},rows:1}),(0,a.jsx)("button",{onClick:R,disabled:!y.trim()||N,className:"w-11 h-11 bg-[#004437] text-white rounded-xl flex items-center justify-center hover:bg-[#005a47] transition-colors disabled:opacity-40 disabled:cursor-not-allowed flex-shrink-0",children:N?(0,a.jsx)("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}):(0,a.jsx)(u.Z,{size:16})})]})]}):(0,a.jsx)("div",{className:"flex-1 flex items-center justify-center bg-[#f0f2f5]",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-[#e8f0ee] rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)(o.Z,{size:28,className:"text-[#004437]"})}),(0,a.jsx)("h3",{className:"text-base font-semibold text-gray-700 mb-1",children:"TaxFlow WhatsApp"}),(0,a.jsx)("p",{className:"text-sm text-gray-400",children:"Selectează o conversație pentru a citi mesajele"})]})})]})}},6474:function(e,t,s){"use strict";s.d(t,{e:function(){return n}});var a=s(6038),r=s(357);function n(){return(0,a.createBrowserClient)(r.env.NEXT_PUBLIC_SUPABASE_URL,r.env.NEXT_PUBLIC_SUPABASE_ANON_KEY)}},7583:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,s(8030).Z)("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]])},6706:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,s(8030).Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]])},4817:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,s(8030).Z)("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]])},994:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,s(8030).Z)("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]])},6463:function(e,t,s){"use strict";var a=s(1169);s.o(a,"usePathname")&&s.d(t,{usePathname:function(){return a.usePathname}}),s.o(a,"useRouter")&&s.d(t,{useRouter:function(){return a.useRouter}}),s.o(a,"useSearchParams")&&s.d(t,{useSearchParams:function(){return a.useSearchParams}})}},function(e){e.O(0,[46,776,971,23,744],function(){return e(e.s=6903)}),_N_E=e.O()}]);