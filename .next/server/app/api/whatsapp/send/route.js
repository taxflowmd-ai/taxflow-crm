"use strict";(()=>{var e={};e.id=824,e.ids=[824],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8301:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>x,patchFetch:()=>w,requestAsyncStorage:()=>_,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var a={};s.r(a),s.d(a,{POST:()=>l});var r=s(9303),n=s(8716),o=s(670),i=s(7070),p=s(7857),u=s(7721),c=s(1615);let d=()=>(0,p.eI)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function l(e){try{let t=(0,c.cookies)(),s=(0,u.createServerClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,{cookies:{getAll:()=>t.getAll(),setAll(){}}}),{data:{user:a}}=await s.auth.getUser();if(!a)return i.NextResponse.json({error:"Neautentificat"},{status:401});let{conversationId:r,message:n}=await e.json();if(!r||!n?.trim())return i.NextResponse.json({error:"Date lipsă"},{status:400});let o=d(),{data:p}=await o.from("whatsapp_conversations").select("wa_phone").eq("id",r).single();if(!p)return i.NextResponse.json({error:"Conversație negăsită"},{status:404});let l=p.wa_phone,m=await fetch(`https://graph.facebook.com/v19.0/${process.env.WHATSAPP_PHONE_NUMBER_ID}/messages`,{method:"POST",headers:{Authorization:`Bearer ${process.env.WHATSAPP_ACCESS_TOKEN}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:l,type:"text",text:{body:n.trim()}})}),_=await m.json();if(!m.ok)return i.NextResponse.json({error:_.error?.message||"Eroare Meta API"},{status:400});let g=_.messages?.[0]?.id;return await o.from("whatsapp_messages").insert({conversation_id:r,wa_message_id:g,direction:"outbound",message_type:"text",body:n.trim(),status:"sent",sent_by:a.id}),await o.from("whatsapp_conversations").update({last_message:n.trim(),last_message_at:new Date().toISOString()}).eq("id",r),i.NextResponse.json({success:!0,messageId:g})}catch(e){return i.NextResponse.json({error:e.message},{status:500})}}let m=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/whatsapp/send/route",pathname:"/api/whatsapp/send",filename:"route",bundlePath:"app/api/whatsapp/send/route"},resolvedPagePath:"/Users/iongonta/Downloads/taxflow-crm/app/api/whatsapp/send/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:g,serverHooks:h}=m,x="/api/whatsapp/send/route";function w(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[948,786,702,972],()=>s(8301));module.exports=a})();