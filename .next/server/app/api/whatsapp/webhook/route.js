"use strict";(()=>{var e={};e.id=975,e.ids=[975],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},8483:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>x,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>w,serverHooks:()=>v,staticGenerationAsyncStorage:()=>f});var s={};a.r(s),a.d(s,{GET:()=>l,POST:()=>m});var o=a(9303),n=a(8716),r=a(670),i=a(7070),u=a(7857),p=a(6113),d=a.n(p);let c=()=>(0,u.eI)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function l(e){let{searchParams:t}=new URL(e.url),a=t.get("hub.mode"),s=t.get("hub.verify_token"),o=t.get("hub.challenge");return"subscribe"===a&&s===process.env.WHATSAPP_WEBHOOK_VERIFY_TOKEN?(console.log("âœ… WhatsApp webhook verificat cu succes"),new i.NextResponse(o,{status:200})):i.NextResponse.json({error:"Token invalid"},{status:403})}async function m(e){try{let t=await e.text(),a=e.headers.get("x-hub-signature-256");if(process.env.META_APP_SECRET&&a){let e="sha256="+d().createHmac("sha256",process.env.META_APP_SECRET).update(t).digest("hex");if(a!==e)return console.error("âŒ SemnÄƒturÄƒ Meta invalidÄƒ"),i.NextResponse.json({error:"SemnÄƒturÄƒ invalidÄƒ"},{status:401})}let s=JSON.parse(t),o=s.entry?.[0]?.changes?.[0]?.value;if(!o)return i.NextResponse.json({status:"no_value"});if(o.messages)for(let e of o.messages)await _(e,o.contacts?.[0]);if(o.statuses)for(let e of o.statuses)await h(e);return i.NextResponse.json({status:"ok"})}catch(e){return console.error("Webhook error:",e),i.NextResponse.json({error:e.message},{status:500})}}async function _(e,t){let a=e.from,s=t?.profile?.name||a,o=e.id,n=c(),r="",i=null,u=null,p=e.type||"text";"text"===e.type?r=e.text?.body||"":"image"===e.type?(r=e.image?.caption||"\uD83D\uDCF7 Imagine",i=e.image?.id,u=e.image?.mime_type):"document"===e.type?(r=e.document?.filename||"\uD83D\uDCC4 Document",i=e.document?.id,u=e.document?.mime_type):"audio"===e.type?(r="\uD83C\uDFB5 Mesaj vocal",i=e.audio?.id):r="location"===e.type?`ðŸ“ ${e.location?.name||e.location?.address||"LocaÈ›ie"}`:`[${e.type}]`;let{data:d}=await n.from("whatsapp_conversations").select("id, unread_count").eq("wa_phone",a).single();if(d)await n.from("whatsapp_conversations").update({last_message:r,last_message_at:new Date().toISOString(),unread_count:(d.unread_count||0)+1,wa_name:s}).eq("id",d.id);else{let e="+"+a,{data:t}=await n.from("leads").select("id").or(`phone.eq.${e},phone.eq.${a}`).single(),{data:o}=await n.from("whatsapp_conversations").insert({wa_phone:a,wa_name:s,lead_id:t?.id||null,last_message:r,last_message_at:new Date().toISOString(),unread_count:1}).select().single();if(d=o,!t&&d){let{data:e}=await n.from("leads").insert({name:s,phone:"+"+a,source:"WhatsApp",status:"Nou"}).select().single();e&&await n.from("whatsapp_conversations").update({lead_id:e.id}).eq("id",d.id)}}d&&await n.from("whatsapp_messages").upsert({conversation_id:d.id,wa_message_id:o,direction:"inbound",message_type:p,body:r,media_url:i,media_mime_type:u},{onConflict:"wa_message_id"})}async function h(e){e.id&&await c().from("whatsapp_messages").update({status:e.status}).eq("wa_message_id",e.id)}let w=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/whatsapp/webhook/route",pathname:"/api/whatsapp/webhook",filename:"route",bundlePath:"app/api/whatsapp/webhook/route"},resolvedPagePath:"/Users/iongonta/Downloads/taxflow-crm/app/api/whatsapp/webhook/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:v}=w,x="/api/whatsapp/webhook/route";function y(){return(0,r.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:f})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[948,786,972],()=>a(8483));module.exports=s})();